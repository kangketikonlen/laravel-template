on:
  push:
    branches:
      - "testing"

name: ðŸŽ¯ Just testing
jobs:
  setup:
    name: ðŸ–¥ï¸ Upload to server
    runs-on: ubuntu-latest
    environment: production
    steps:
    - name: ðŸ™ Git checkout
      uses: actions/checkout@v3
    - name: ðŸ“ Make sure repository is latest
      run: git fetch --prune --unshallow
    - name: â–¶ï¸ Running shell script
      run: |
        cd .docker/server
        bash bin/create-storage.sh
        bash bin/generate-env.sh
    - name: ðŸš€ Update server
      uses: cross-the-world/ssh-scp-ssh-pipelines@latest
      with:
        host: ${{ secrets.SERVER }}
        user: ${{ secrets.USERNAME }}
        pass: ${{ secrets.PASSWORD }}
        port: ${{ secrets.SSH_PORT }}
        connect_timeout: 120s
        scp: |
          '.docker/server/.env' => ${{ secrets.DIRECTORY }}
          '.docker/server/run.sh' => ${{ secrets.DIRECTORY }}
          '.docker/server/storage' => ${{ secrets.DIRECTORY }}
          '.docker/server/docker-compose.yml' => ${{ secrets.DIRECTORY }}
        last_ssh: |
          cd ${{ secrets.DIRECTORY }}
          sed -i "s/DOCKER_IMAGE_VERSION=.*/DOCKER_IMAGE_VERSION=2.0/g" .env
          sed -i "s/DB_USERNAME=.*/DB_USERNAME=${{secrets.DB_USERNAME}}/g" .env
          sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=${{secrets.DB_PASSWORD}}/g" .env
          sed -i "s/DOCKER_DATABASE_USERNAME=.*/DOCKER_DATABASE_USERNAME=${{secrets.DOCKER_DATABASE_USERNAME}}/g" .env
          sed -i "s/DOCKER_DATABASE_PASSWORD=.*/DOCKER_DATABASE_PASSWORD=${{secrets.DOCKER_DATABASE_PASSWORD}}/g" .env
          bash run.sh
